你现在这套是 **GitHub 拉代码 + docker compose 本地 build** 的部署，所以更新流程本质上就是：

**git pull → 重新 build 镜像 → docker compose up 重新拉起 → 健康检查**
（数据库不动，因为数据在 volume 里。）

下面给你一套“稳妥版”流程，直接照抄执行就行。

---

## 0）先提醒一个坑（很重要）

你之前为了修 Prisma/OpenSSL，手动改过 `apps/api/Dockerfile`（加了 `apk add openssl`）。
**如果这改动没提交到 GitHub**，你以后 `git pull` 很可能把它覆盖掉，API 又会起不来。

建议二选一：

* ✅ **最好：把这个修复提交并 push 到 GitHub**（永久解决）
* 或者：每次 pull 后都检查 Dockerfile 里这行还在不在

---

## 1）更新前可选：备份数据库（推荐）

```bash
mkdir -p /opt/backup
cd /opt/guiguan
docker compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres -d guiguan \
  > /opt/backup/guiguan_$(date +%F_%H%M).sql
```

---

## 2）标准更新流程（后端+前端一起更新，尽量不动数据库）

```bash
cd /opt/guiguan

# 看看有没有本地改动（尤其是 apps/api/Dockerfile）
git status

# 如果有本地改动但你还没提交，先存一下，避免 pull 冲突
git stash push -m "local changes before deploy" || true

# 拉最新代码
git pull --rebase

# 如果你 stash 过，需要把改动恢复回来（仅当你确实要保留本地改动）
git stash pop || true

# 重新构建并更新容器（不会删 volume，所以数据库数据不会丢）
docker compose -f docker-compose.prod.yml up -d --build

# 看状态
docker compose -f docker-compose.prod.yml ps
```

> 你现在 api 的启动命令里自带 `prisma migrate deploy`，所以如果这次更新包含新 migration，它会自动应用；**不包含 migration 就不会改表结构**。

---

## 3）只更新前端（完全不动 API/DB）

如果你只是改了 student/teacher/admin 页面：

```bash
cd /opt/guiguan
git pull --rebase
docker compose -f docker-compose.prod.yml up -d --build student teacher admin
```

---

## 4）更新后必做：健康检查

```bash
curl -I https://api.gui-guan.com/health
curl -I https://gui-guan.com
curl -I https://admin.gui-guan.com/login
curl -I https://teacher.gui-guan.com/login
```

---

## 5）如果你改了 Nginx 配置（比如你手动改过 /etc/nginx/sites-available/guiguan.conf）

更新代码不会自动更新 Nginx。你改完 Nginx 后要：

```bash
nginx -t && systemctl reload nginx
```

---

## 6）出问题时快速回滚（不动数据库）

你可以回到上一个版本代码，再重新 build：

```bash
cd /opt/guiguan
git reflog --date=iso | head
# 找到上一个正常的 commit/状态后：
git reset --hard <commit_sha>
docker compose -f docker-compose.prod.yml up -d --build
```

---

如果你愿意，我可以把上面这一整套封成一个脚本（比如 `/usr/local/bin/deploy-guiguan`），以后你就一条命令完成：备份→pull→build→up→健康检查。你说一声就行。
