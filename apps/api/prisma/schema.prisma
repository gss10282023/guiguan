generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum Currency {
  AUD
  CNY
  USD
}

enum Subject {
  GENERAL
  ENGLISH
  CHINESE
  MATHEMATICS
  CHEMISTRY
  PHYSICS
  BIOLOGY
  ECONOMICS
  BUSINESS_STUDIES
  LEGAL_STUDIES
  MODERN_HISTORY
  ANCIENT_HISTORY
  GEOGRAPHY
}

enum SessionStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

enum HourLedgerReason {
  PURCHASE
  ADJUSTMENT
  SESSION_CONSUME
}

enum ChangeRequestType {
  CANCEL
  RESCHEDULE
}

enum ChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  auditLogs AuditLog[]
}

model User {
  id           String     @id @default(cuid())
  orgId        String
  email        String?    @unique
  phone        String?    @unique
  passwordHash String
  role         UserRole
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?

  taughtRates  TeacherStudentRate[] @relation("TeacherRates")
  learnedRates TeacherStudentRate[] @relation("StudentRates")

  teachingSessions Session[] @relation("TeachingSessions")
  learningSessions Session[] @relation("LearningSessions")
  createdSessions  Session[] @relation("CreatedByAdmin")

  hourLedgerEntries       HourLedgerEntry[] @relation("StudentLedger")
  teacherLedgerEntries    HourLedgerEntry[] @relation("TeacherLedger")
  requestedChangeRequests ChangeRequest[]   @relation("RequestedByUser")
  decidedChangeRequests   ChangeRequest[]   @relation("DecidedByAdmin")

  auditLogs AuditLog[] @relation("ActorAuditLogs")

  @@index([orgId])
}

model StudentProfile {
  userId      String   @id
  displayName String
  timeZone    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TeacherProfile {
  userId      String   @id
  displayName String
  timeZone    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TeacherStudentRate {
  id              String   @id @default(cuid())
  teacherId       String
  studentId       String
  subject         Subject  @default(GENERAL)
  hourlyRateCents Int
  currency        Currency
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  teacher User @relation("TeacherRates", fields: [teacherId], references: [id], onDelete: Cascade)
  student User @relation("StudentRates", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([teacherId, studentId, subject])
  @@index([teacherId])
  @@index([studentId])
  @@index([subject])
}

model Session {
  id                String        @id @default(cuid())
  teacherId         String
  studentId         String
  subject           Subject       @default(GENERAL)
  startAtUtc        DateTime
  endAtUtc          DateTime
  classTimeZone     String
  status            SessionStatus @default(SCHEDULED)
  consumesUnits     Int           @default(1)
  rateCentsSnapshot Int
  currencySnapshot  Currency
  createdByAdminId  String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  teacher        User @relation("TeachingSessions", fields: [teacherId], references: [id], onDelete: Restrict)
  student        User @relation("LearningSessions", fields: [studentId], references: [id], onDelete: Restrict)
  createdByAdmin User @relation("CreatedByAdmin", fields: [createdByAdminId], references: [id], onDelete: Restrict)

  hourLedgerEntry HourLedgerEntry?
  changeRequests  ChangeRequest[]

  @@index([teacherId, startAtUtc])
  @@index([studentId, startAtUtc])
  @@index([createdByAdminId])
}

model HourLedgerEntry {
  id         String           @id @default(cuid())
  studentId  String
  teacherId  String?
  deltaUnits Int
  reason     HourLedgerReason
  sessionId  String?          @unique
  createdAt  DateTime         @default(now())

  student User     @relation("StudentLedger", fields: [studentId], references: [id], onDelete: Restrict)
  teacher User?    @relation("TeacherLedger", fields: [teacherId], references: [id], onDelete: SetNull)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([teacherId])
}

model ChangeRequest {
  id                 String              @id @default(cuid())
  sessionId          String
  type               ChangeRequestType
  proposedStartAtUtc DateTime?
  proposedEndAtUtc   DateTime?
  proposedTimeZone   String?
  status             ChangeRequestStatus @default(PENDING)
  requestedByUserId  String
  decidedByAdminId   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  session         Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  requestedByUser User    @relation("RequestedByUser", fields: [requestedByUserId], references: [id], onDelete: Restrict)
  decidedByAdmin  User?   @relation("DecidedByAdmin", fields: [decidedByAdminId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([status])
  @@index([requestedByUserId])
  @@index([decidedByAdminId])
}

model AuditLog {
  id          String   @id @default(cuid())
  orgId       String
  actorUserId String
  action      String
  entityType  String
  entityId    String
  meta        Json?
  createdAt   DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actorUser    User         @relation("ActorAuditLogs", fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([orgId, createdAt])
  @@index([actorUserId, createdAt])
}
